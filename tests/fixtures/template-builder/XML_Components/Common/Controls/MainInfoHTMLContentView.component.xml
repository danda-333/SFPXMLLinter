<?xml version="1.0" encoding="utf-8"?>
<Component xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:dsp="http://www.gappex.com/sfp/DataSource/Parameters" xmlns:wffc="http://www.gappex.com/sfp/WorkFlow/FormControl" xmlns:fi="http://www.gappex.com/sfp/Form/Indexes" xmlns:fcs="http://www.gappex.com/sfp/Form/Control/Settings" xmlns:dsf="http://www.gappex.com/sfp/DataSource/Froms" xmlns:dws="http://www.gappex.com/sfp/DataView/Settings" xmlns:dvs="http://www.gappex.com/sfp/DataView/Settings" xmlns:fccom="http://www.gappex.com/sfp/Form/Control/Communication">
	
	<Section Root="Form" Name="Controls" TargetXPath="//Form/Controls" Insert="append">
		<Control xsi:type="HTMLContentViewControl" Ident="MainInfoHTMLContentView" IsRazorEngine="true">
			<Sources>
				<DataSource Ident="Main">
					<Columns>
						<!-- @Ignore unknown-form-ident -->
						<Column xsi:type="WorkFlowStateColumn" Ident="State" IsColor="true" FormIdent="{{FormIdent}}" />
						<Column Ident="ITSMGeneralResolutionMethodTypeGuid" />
						<Column Ident="Header" />
						<Column Ident="AccountID" />
						<Column Ident="CreateDate" DataType="DateTime" />
						<Column Ident="LastUpdateAccountID" />
						<Column Ident="LastUpdate" DataType="DateTime" />
						<Column Ident="AssignedGroupID" />
						<Column Ident="AssignedAccountID" />
					</Columns>
					<SQL>
						SELECT
							ISNULL(itsReq.[State], 1) AS [State]
							,itsGrmt.[TextValue] AS ITSMGeneralResolutionMethodTypeGuid

							,IIF(itsReq.ID IS NOT NULL,
								CONCAT('<a href="~/Form/Detail/{{FormIdent}}/', itsReq.ID,'">', itsReq.ITSMKey,'</a>| ', itsReq.Subject)
							,usr.GetResourceText('CreatingNew{{FormIdent}}_Information_ITSM', @UserLanguageID)) AS Header

							,accCreator.FullName AS AccountID
							,itsReq.CreateDate

							,accLastUpdate.FullName AS LastUpdateAccountID
							,itsReq.LastUpdate

							,groAssigned.[Name] AS AssignedGroupID
							,accAssigned.[FullName] AS AssignedAccountID

						FROM (VALUES (0)) AS dual(zero)
						LEFT JOIN usr.{{FormIdent}} AS itsReq ON itsReq.ID = @ID
						LEFT JOIN dbo.[Group] AS groAssigned ON groAssigned.ID = itsReq.AssignedGroupID
						LEFT JOIN dbo.Account AS accAssigned ON accAssigned.ID = itsReq.AssignedAccountID
						LEFT JOIN dbo.Account AS accCreator ON accCreator.ID = ISNULL(itsReq.AccountID, @UserID)
						LEFT JOIN dbo.Account AS accLastUpdate ON accLastUpdate.ID = itsReq.LastUpdateAccountID
						LEFT JOIN usr.ITSMGeneralResolutionMethodType AS itsGrmt ON itsGrmt.Guid = itsReq.ITSMGeneralResolutionMethodTypeGuid AND itsGrmt.LanguageID = @UserLanguageID
					</SQL>
					<Parameters>
						<dsp:Parameter xsi:type="dsp:VariableParameter" Ident="ID" DataType="Number" />
						<dsp:Parameter xsi:type="dsp:VariableParameter" Ident="UserID" DataType="Number" ConstantType="UserID" />
						<dsp:Parameter xsi:type="dsp:VariableParameter" Ident="UserLanguageID" DataType="Number" ConstantType="UserLanguageID" />
					</Parameters>
				</DataSource>
				<DataSource Ident="SLAs">
					<Columns>
						<Column Ident="SLAType" />
						<Column Ident="SLAStatus" />
						<Column Ident="SLADate" />
						<Column Ident="SLASpentTime" />
						<Column Ident="SLASpentPercent" />
						<Column Ident="SLARemainingTime" />
						<Column Ident="SLARemainingPercent" />
						<Column Ident="CalendarName" />
						<Column Ident="SLAStatusColorCssClass" />
					</Columns>
					<SQL>
						SELECT
							CONCAT(itsGsc.SLAType, '_SLAType_ITSM') AS SLAType
							,CONCAT(itsGsc.SLAStatus, '_SLAType_ITSM') AS SLAStatus
							,itsGsc.FinishTime AS SLADate
							,itsGsc.TimeSpent AS SLASpentTime
							,itsGsc.PercentSpent AS SLASpentPercent
							,itsGsc.TimeRemain AS SLARemainingTime
							,itsGsc.PercentRemain AS SLARemainingPercent
							,itsGsc.SLAName AS CalendarName
							,CONCAT('bg-', itsGsc.SLAStatusColorCssClass) AS SLAStatusColorCssClass
						FROM usr.{{FormIdent}} AS itsReq
						CROSS APPLY usr.ITSM_GetSLAComputes (itsReq.ID, '{{FormIdent}}', NULL) AS itsGsc
						WHERE
							itsReq.ID = @ID
						ORDER BY itsGsc.SLATypePriority
					</SQL>
					<Parameters>
						<dsp:Parameter xsi:type="dsp:VariableParameter" Ident="ID" DataType="Number" />
					</Parameters>
				</DataSource>
			</Sources>
			<HTMLTemplate><![CDATA[
				@{
					var mainData = Model.Data.Main[0];
				}

				<div class="d-flex flex-wrap">
					<div class="d-flex flex-wrap justify-content-between" style="flex: 999 1 min(100%, 650px);">
						<div style="flex: 999 1 min(100%, 450px); font-size: 16px;">
							@mainData.Header
							<small class="d-block text-muted ml-0 font-size-sm">
								[#Created_ITSM#]: @mainData.AccountID @if(!(mainData.CreateDate is System.DBNull)){@mainData.CreateDate}
								@if(!(mainData.LastUpdate is System.DBNull)){<text>, [#Updated_ITSM#]: @mainData.LastUpdateAccountID @mainData.LastUpdate</text>}
							</small>
						</div>
						<div style="flex: 1 1 auto;">
							<ul class="list-group list-group-flush m-0">
								<li class="list-group-item" style="padding: .3rem .5rem;">
									<span class="font-weight-semibold mr-2">[#State_ITSM#]:</span>
									<div class="ml-auto">@mainData.State</div>
								</li>
								@if(!(mainData.ITSMGeneralResolutionMethodTypeGuid is System.DBNull)){
								<li class="list-group-item" style="padding: .3rem .5rem;">
									<span class="font-weight-semibold mr-2">[#ITSMGeneralResolutionMethodTypeGuid_ITSM#]:</span>
									<div class="ml-auto">@mainData.ITSMGeneralResolutionMethodTypeGuid</div>
								</li>
								}
								@if(!(mainData.AssignedGroupID is System.DBNull)){
								<li class="list-group-item" style="padding: .3rem .5rem;">
									<span class="font-weight-semibold mr-2">[#AssignedGroupID_ITSM#]:</span>
									<div class="ml-auto">@mainData.AssignedGroupID</div>
								</li>
								}
								@if(!(mainData.AssignedAccountID is System.DBNull)){
								<li class="list-group-item" style="padding: .3rem .5rem;">
									<span class="font-weight-semibold mr-2">[#AssignedAccountID_ITSM#]:</span>
									<div class="ml-auto">@mainData.AssignedAccountID</div>
								</li>
								}
							</ul>
						</div>
					</div>
					<div class="d-flex flex-wrap align-items-start gap-1-lmtl4" style="flex: 1 1 auto;">
						@foreach(var item in Model.Data.SLAs){
						<div class="d-flex flex-column" style="flex: 1 1 auto;">
							<div class="card-body @item.SLAStatusColorCssClass m-0">
								<div class="d-flex">
									<h3 class="font-weight-semibold mb-0 font-size-lg">@item.SLAType</h3>
									<div class="list-icons ml-auto">
										@item.SLADate
										<!--<a class="list-icons-item ml-1" data-action="reload"></a>-->
									</div>
								</div>
								<div>
									<div class="d-flex line-height-sm">
										<span class="mr-2">[#SLASpent_ITSM#]:</span><span class="ml-auto">@item.SLASpentTime &bull; @(item.SLASpentPercent)%</span>
									</div>
									<div class="d-flex line-height-sm">
										<span class="mr-2">[#SLARemaining_ITSM#]:</span><span class="ml-auto">@item.SLARemainingTime &bull; @(item.SLARemainingPercent)%</span>
									</div>
									<div class="d-flex line-height-sm">
										<span class="mr-2">[#Calendar_ITSM#]:</span><span class="ml-auto">@item.CalendarName</span>
									</div>
									<div class="d-flex line-height-sm">
										<span class="mr-2">[#SLAStatus_ITSM#]:</span><span class="ml-auto">@item.SLAStatus</span>
									</div>
								</div>
							</div>
							<div class="progress bg-white" style="height: 0.375rem; border-radius: 0;">
								<div class="progress-bar bg-success" style="width: @(item.SLASpentPercent)%">
									<span class="sr-only">@(item.SLASpentPercent)% To end</span>
								</div>
							</div>
						</div>
						}
					</div>
				</div>



			]]></HTMLTemplate>
		</Control>
	</Section>

	<Section Root="Form" Name="Section" TargetXPath="//Form/Sections" Insert="prepend">
		<Section Root="Form" xsi:type="HeaderSection" Ident="HeaderSection">
			<HTMLTemplate>
				<style>
					#MainInfoHTMLContentView {
						width: 100%;
					}

					#sfpFormMainHeader {
						padding-left: 0 !important;
						padding-right: 0 !important;
					}
				</style>
				<Control ID="MainInfoHTMLContentView" />
			</HTMLTemplate>
		</Section>
	</Section>
	
</Component>
